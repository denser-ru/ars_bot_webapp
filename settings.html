<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Настройки</title>
	<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
	<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
	<script src="https://unpkg.com/@babel/standalone@7.10.3/babel.min.js" crossorigin></script>
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
	<!-- Подключение стилей flatpickr -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<!-- Подключение скрипта flatpickr -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<!-- Подключение скрипта локализации для русского языка -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

	<style>
		body {
			color: var(--tg-theme-text-color);
			background: var(--tg-theme-bg-color);
		}

		.hint {
			color: var(--tg-theme-hint-color);
		}

		.link {
			color: var(--tg-theme-link-color);
		}

		.button {
			background: var(--tg-theme-button-color);
			color: var(--tg-theme-button-text-color);
		}
	</style>
</head>
<body>
	<div id="root"></div>

	<script type="text/babel" data-presets="react,stage-3">
		const Settings = () => {
			const [startDate, setStartDate] = React.useState('');
			const [endDate, setEndDate] = React.useState('');
			const [sortBy, setSortBy] = React.useState('date'); // 'date' или 'relevance'


			let WebApp = window.Telegram.WebApp;
			let MainButton = WebApp.MainButton;
			MainButton.show();

			const urlParams = new URLSearchParams(window.location.search);
			const encodedSettings = urlParams.get('settings');

			// Инициализация flatpickr после загрузки компонента
			React.useEffect(() => {
				try {
					const decodedSettings = JSON.parse(atob(encodedSettings));
					console.log(decodedSettings);
					// Установка дат начала и конца, если они существуют в decodedSettings
					if (decodedSettings) {
						if (decodedSettings.start_date) {
							setStartDate(decodedSettings.start_date);
						}
						if (decodedSettings.end_date) {
							setEndDate(decodedSettings.end_date);
						}
						if (decodedSettings.sort_by) {
							setSortBy(decodedSettings.sort_by);
						}
				}
				} catch (error) {
					console.error('Ошибка при декодировании настроек:', error);
				}
				flatpickr('.date-input', {
					locale: 'ru', // Установка русского языка
					firstDayOfWeek: 1, // Начало недели с понедельника
					minDate: '2019-01-01', // Минимальная дата
					maxDate: new Date(), // Максимальная дата - сегодняшняя дата
					onChange: (selectedDates, dateStr, instance) => {
						// Обновление состояния в зависимости от того, какое поле ввода изменено
						if (instance.input.name === 'start_date') {
							setStartDate(dateStr);
						} else if (instance.input.name === 'end_date') {
							setEndDate(dateStr);
						}
					}
				});
			}, []);

			// Функция для обработки отправки формы
			const handleSubmit = () => {
				const settings = {
				start_date: startDate,
				end_date: endDate,
				sort_by: sortBy
				};
				// Отправка данных обратно в бота
				Telegram.WebApp.sendData(JSON.stringify(settings));
			};

			return (
				<div style={{ backgroundColor: 'var(--tg-theme-bg-color)', color: 'var(--tg-theme-text-color)' }}>
					<div className="form-group">
						<label htmlFor="start_date" style={{ color: 'var(--tg-theme-text-color)' }}>Дата начала поиска:</label>
						<input
							type="text"
							className="form-control date-input"
							id="start_date"
							name="start_date"
							value={startDate}
							onChange={(e) => setStartDate(e.target.value)}
						/>
					</div>
					<div className="form-group">
						<label htmlFor="end_date" style={{ color: 'var(--tg-theme-text-color)' }}>Дата окончания:</label>
						<input
							type="text"
							className="form-control date-input"
							id="end_date"
							name="end_date"
							value={endDate}
							onChange={(e) => setEndDate(e.target.value)}
						/>
					</div>
					<div>
						<p style={{ color: 'var(--tg-theme-text-color)' }}>Сортировка по:</p>
						<input
							type="radio"
							id="date"
							name="sort"
							value="date"
							checked={sortBy === 'date'}
							onChange={() => setSortBy('date')}
							style={{ accentColor: 'var(--tg-theme-button-color)' }}
						/>
						<label htmlFor="date" style={{ color: 'var(--tg-theme-text-color)' }}>По дате</label>
						<input
							type="radio"
							id="relevance"
							name="sort"
							value="relevance"
							checked={sortBy === 'relevance'}
							onChange={() => setSortBy('relevance')}
							style={{ accentColor: 'var(--tg-theme-button-color)' }}
						/>
						<label htmlFor="relevance" style={{ color: 'var(--tg-theme-text-color)' }}>По релевантности</label>
					</div>
					<button
						onClick={handleSubmit}
						style={{
							backgroundColor: 'var(--tg-theme-button-color)',
							color: 'var(--tg-theme-button-text-color)'
						}}
					>
						Сохранить настройки
					</button>
					<p>
						<div style={{fontSize: "8px"}}>v007</div>
					</p>
				</div>
			);
		};

		const root = ReactDOM.createRoot(document.getElementById("root"));
		root.render(<Settings />);
	</script>
</body>
</html>
