<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Настройки</title>
	<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
	<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
	<script src="https://unpkg.com/@babel/standalone@7.10.3/babel.min.js" crossorigin></script>
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
	<!-- Подключение стилей flatpickr -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<!-- Подключение скрипта flatpickr -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<!-- Подключение скрипта локализации для русского языка -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

	<style>
		body {
			color: var(--tg-theme-text-color);
			background: var(--tg-theme-bg-color);
		}

		.hint {
			color: var(--tg-theme-hint-color);
		}

		.link {
			color: var(--tg-theme-link-color);
		}

		.button {
			background: var(--tg-theme-button-color);
			color: var(--tg-theme-button-text-color);
		}
	</style>
</head>
<body>
	<div id="root"></div>

	<script type="text/babel" data-presets="react,stage-3">
		const Settings = () => {
			const [startDate, setStartDate] = React.useState('');
			const [endDate, setEndDate] = React.useState('');
			const [sortBy, setSortBy] = React.useState('date'); // 'date' или 'relevance'


			// let WebApp = window.Telegram.WebApp;
			// let MainButton = WebApp.MainButton;
			// MainButton.show();


			// Инициализация flatpickr после загрузки компонента
			React.useEffect(() => {
				const urlParams = new URLSearchParams(window.location.search);
				const encodedSettings = urlParams.get('settings');
				let initialStartDate = '';
				let initialEndDate = '';
				try {
					const decodedSettings = JSON.parse(atob(encodedSettings));
					console.log(decodedSettings);
					// Установка дат начала и конца, если они существуют в decodedSettings
					if (decodedSettings) {
						if (decodedSettings.start_date) {
							setStartDate(decodedSettings.start_date);
							initialStartDate = decodedSettings.start_date;
						}
						if (decodedSettings.end_date) {
							setEndDate(decodedSettings.end_date);
							initialEndDate = decodedSettings.end_date;
						}
						if (decodedSettings.sort_by) {
							setSortBy(decodedSettings.sort_by);
						}
				}
				} catch (error) {
					console.error('Ошибка при декодировании настроек:', error);
				}
				// Инициализация flatpickr для поля начальной даты
				flatpickr('#start_date', {
					locale: 'ru',
					firstDayOfWeek: 1,
					minDate: '2019-01-01',
					maxDate: new Date(),
					defaultDate: initialStartDate, // Только начальная дата
					onChange: (selectedDates, dateStr) => {
						setStartDate(dateStr);
					}
				});

				// Инициализация flatpickr для поля конечной даты
				flatpickr('#end_date', {
					locale: 'ru',
					firstDayOfWeek: 1,
					minDate: '2019-01-01',
					maxDate: new Date(),
					defaultDate: initialEndDate, // Только конечная дата
					onChange: (selectedDates, dateStr) => {
						setEndDate(dateStr);
					}
				});
			}, []);

			// Функция для обработки отправки формы
			const handleSubmit = () => {
				const settings = {
				start_date: startDate,
				end_date: endDate,
				sort_by: sortBy
				};
				// Отправка данных обратно в бота
				Telegram.WebApp.sendData(JSON.stringify(settings));
			};


			let WebApp = window.Telegram.WebApp;
			let MainButton = WebApp.MainButton;

			MainButton.setText('Сохранить настройки');
			MainButton.show();

			// Привязываем функцию отправки к событию клика по кнопке
			MainButton.onClick(() => {
				handleSubmit(); // Ваша функция отправки данных
			});

			return (
				<div>
					<div className="form-group">
						<label htmlFor="start_date">Дата начала поиска:</label>
						<input
							type="text"
							className="form-control date-input"
							id="start_date"
							name="start_date"
						/>
					</div>
					<div className="form-group">
						<label htmlFor="end_date">Дата окончания:</label>
						<input
							type="text"
							className="form-control date-input"
							id="end_date"
							name="end_date"
						/>
					</div>
					<div>
						<p>Сортировка по:</p>
						<input
							type="radio"
							id="date"
							name="sort"
							value="date"
							checked={sortBy === 'date'}
							onChange={() => setSortBy('date')}
						/>
						<label htmlFor="date">По дате</label>
						<input
							type="radio"
							id="relevance"
							name="sort"
							value="relevance"
							checked={sortBy === 'relevance'}
							onChange={() => setSortBy('relevance')}
						/>
						<label htmlFor="relevance">По релевантности</label>
					</div>
					<button
						onClick={handleSubmit}
					>
						Сохранить настройки
					</button>
					<p>
						<span style={{fontSize: "8px"}}>v_a0.0.013</span>
					</p>
				</div>
			);
		};

		const root = ReactDOM.createRoot(document.getElementById("root"));
		root.render(<Settings />);
	</script>
</body>
</html>
